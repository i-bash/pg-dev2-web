<h3>Магазин</h3>
<form id="catalog" class="form-inline panel" action="emp/getBooks">
	<div class="form-group clearfix">
		<input id="search" class="form-control" name="search" placeholder="...."/>
	</div>
	<div class="form-group clearfix">
		<select id="orderby" class="form-control" name="orderby">
			<option value="format">Формат</option>
			<option value="rating">Рейтинг</option>
			<option value="price">Цена</option>
		</select>
	</div>
	<div class="form-group clearfix">
		<select id="direction" class="form-control" name="direction">
			<option value="asc">asc</option>
			<option value="desc">desc</option>
		</select>
	</div>
	<button type="submit" class="btn btn-primary">Найти</button>
</form>
<div id="books" class="container">
	<div id="headers" style="display:none;" class="row">
		<span class="col-6 font-weight-bold">Название</span>
		<span class="col-2 font-weight-bold text-right">Наличие</span>
		<span class="col-2"></span>
		<span class="col-2 font-weight-bold text-right">Цена</span>
	</div>
</div>
<script>
		//gen pseudo-random based on string hash (-0.5 .. 0.5)
		String.prototype.hashRandom = function(){return this.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0)/2**31};
		//generate book order price
		let genPrice=book=>{
			return book.pages*1.5        //1.5 rub/page
				*book.title.hashRandom() //-0.5 to +0.5
				*(0.8+0.4*Math.random()) // +- 20%
			;
		}
		//display books
		lib.ajaxForm(
			'#catalog',
			data=>{
				lib.alert(data.rows.length==0?'Книги не найдены':'Найдено книг: '+data.rows.length);
				$('#headers').toggle(data.rows.length>0);
				let list=$('#books');
				list.children('div:not(:first-child)').remove();
				data.rows.forEach(
					r=>{
						$('<div/>',{class:'row book'})
							.append($('<span/>',{class:'col-6 my-auto'}).html(r.title+' '+r.authors_list.length))
							.append(
								$('<span/>',{class:'col-4 container'})
								.append(
									$('<div/>',{class:'row'})
									.append($('<span/>',{class:'col-6 text-right'}).html(r.onhand_qty))
									.append($('<button/>',{class:'col-4 btn btn-primary btn-sm order'}).html('Заказать'))
								)
								.append(
									$('<form/>',{class:'order-book row d-none',action:'emp/orderBook'})
									.append($('<input/>',{name:'qty',type:'number',min:'1',class:'col-6 text-right',required:'required',value:'1'}))
									.append($('<input/>',{name:'book_id',type:'hidden'}).val(r.book_id))
									.append($('<input/>',{name:'price',type:'hidden'}).val(genPrice(r)))
									.append($('<button/>',{class:'col-4 btn btn-primary btn-sm'}).html('Заказать'))
									.append($('<button/>',{type:'reset',class:'col-2 btn btn-primary btn-sm cancel'}).html('&times;'))
								)
							)
							.append($('<span/>',{class:'col-2 text-right'}).html(r.price))
							.appendTo(list)
						;
					}
				);
			}
		);
		lib.ajaxForm(
			'.book form.order-book',
			(data,form)=>{
				lib.alert('books have been ordered');
				$(form).children('button[type="reset"]').trigger('click');
				$('#catalog').trigger('submit');
			}
		);
		
		//event handlers
		$('#books').on(
			'click',
			'button.order',
			e=>{
				let orderButton=$(e.currentTarget);
				orderButton.parent().addClass('d-none');
				orderButton.parent().siblings('form.row').removeClass('d-none');
				orderButton.parent().siblings('form.row').find('input[name="qty"]').focus().select();
			}
		);
		$('#books').on(
			'click',
			'button.cancel',
			e=>{
				let cancelButton=$(e.currentTarget);
				cancelButton.parent().addClass('d-none');
				cancelButton.parent().siblings('div.row').removeClass('d-none');
			}
		);
</script>
