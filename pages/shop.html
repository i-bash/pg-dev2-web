						<form id="search" class="form-inline pt-2" action="web/findBooks">
							<div class="container text-right clearfix">
								<input id="search_string" class="form-control text-right mb-2" name="search" placeholder="Автор или название">
								<button type="submit" class="btn btn-primary mb-2">Найти</button>
								<select id="orderby" name="orderby" class="form-control">
									<option>1</option>
									<option>2</option>
									<option>3</option>
								</select>
								<select id="direction" name="direction" class="form-control">
									<option>asc</option>
									<option>desc</option>
								</select>
							</div>
						</form>
						<div id="books" class="container">
							<div id="headers" class="row">
								<span class="col-2">Обложка</span>
								<span class="col-4">Название, авторы</span>
								<span class="col-1">Рейтинг</span>
								<span class="col-2">Формат</span>
								<span class="col-1 text-right">Цена</span>
								<span class="col-2"></span>
							</div>
						</div>
						<div id="book" class="book">
							<div id="book-details" class="container">
								<div class="row">
									<div class="col-3">
										<div>Обложка</div>
										<div><img src="img/book.png" class="w-50"></div>
									</div>
									<div class="col-6">
										<div class="container">
											<div class="row">
												<div class="col-4">Название</div>
												<div class="col-8" id="det-name"></div>
											</div>
											<div class="row">
												<div class="col-4">Авторы</div>
												<div class="col-8" id="det-authors"></div>
											</div>
											<div class="row">
												<div class="col-4">Рейтинг</div>
												<div class="col-1" id="det-rating"></div>
												<div class="col-1">
													<button id="vote-up" class="btn btn-sm btn-outline-success vote" data-vote="+1">+</button>
												</div>
												<div class="col-2" id="det-votes-up"></div>
												<div class="col-1">
													<button class="btn btn-sm btn-outline-danger vote" data-vote="-1">-</button>
												</div>
												<div class="col-2" id="det-votes-down"></div>
											</div>
											<div class="row">
												<div class="col-4">Формат</div>
												<div class="col-8" id="det-format"></div>
											</div>
											<div class="row">
												<div class="col-12" id="det-other"></div>
											</div>
										</div>
									</div>
									<div class="col-3">
										<div><span class="pr-2">Цена</span><span id="det-price"></span></div>
										<div><button type="button" class="btn btn-secondary btn-sm to-cart">В корзину</button></div>
									</div>
								</div>
							</div>
							<div><button id="to-list" class="btn btn-primary">К списку книг</button></div>
						</div>
<script>
	{
		//functions
		
		//fill and initially display list of books
		let initBooks =data=>{
			let list=$('#books');
			list.children('div:not(:first-child)').remove();
			data.rows.forEach(
				r=>{
					$('<div/>',{class:'row book'})
						.data('book',r)
						.data('id',r.book_id)
						.append(
							$('<span/>',{class:'col-2'})
								.append(
									$('<a/>',{href:'#'}).append($('<img/>',{src:'img/book.png',class:'w-50'})) //'server.php?action=web/getImage&book_id='+r.book_id
							)
						)
						.append(
							$('<span/>',{class:'col-4'})
							.html(
								r.title+
								'. '+
								r.authors_list.map(
									author=>author.last_name+' '+author.first_name[0]+'.'+(author.last_name?' '+author.last_name[0]+'.':'')
								).join(', ')
							)
						)
						.append($('<span/>',{class:'col-1'}).html(r.rating))
						.append($('<span/>',{class:'col-2'}).html(r.format))
						.append($('<span/>',{class:'col-1 text-right'}).html(r.price))
						.append($('<span/>',{class:'col-2'}).append(
							$('<button/>',{type:'button',class:'btn btn-secondary btn-sm to-cart'}).html('В корзину')
						))
						.appendTo(list)
					;
				}
			);
			showList();
			$('#books').toggle(data.rows.length>0);
			lib.alert(data.rows.length==0?'Книги не найдены':'Найдено книг: '+data.rows.length);
		};
		//display book details
		let showDetails=data=>{
			$('#book').data('id',data.book_id);
			$('#det-name').html(data.title);
			$('#det-authors').html(data.authors_list.map(r=>r.last_name+' '+r.first_name+' '+r.middle_name).join(',<br>'));
			$('#det-rating').html(data.rating);
			$('#det-votes-up').html(data.votes_up);
			$('#det-votes-down').html(data.votes_down);
			$('#det-format').html(data.format);
			$('#det-other').html(data.additional);
			$('#det-price').html(data.price).siblings('button').data('id',data.book_id);
			$('#book').toggle(true);
			$('#books').toggle(false);
			$('#shop').trigger('shop:login-logout');
		};
		//display list of books
		let showList=()=>{
			$('#book').toggle(false);
			$('#books').toggle(true);
			$('#shop').trigger('shop:login-logout');
		};
		
		//event handlers
		
		$('#shop').on(
			'shop:login-logout',
			e=>{
				//enable to-cart and vote buttons for logged in user only
				$('#books,#book').find('button.to-cart,button.vote').toggle(sessionStorage.getItem('authToken')!==null);
				//display cart info in header
				refreshCartInfo();
			}
		);
		
		$('#orderby,#direction').change(
			()=>{
				$('#search').submit();
			}
		);
		
		$('#books').on(
			'show load ',
			'img',
			e=>{
				alert(e);
			}
		);
		$('#books').on(
			'click',
			'img',
			e=>{
				showDetails($(e.target).closest('.book').data('book'));
			}
		);
		$('#books,#book-details').on(
			'click',
			'button.to-cart',
			e=>{
				lib.server(
					'web/toCart',
					{book_id:$(e.target).closest('.book').data('id'),auth_token:sessionStorage.getItem('authToken')},
					data=>{lib.alert('added to cart');refreshCartInfo();}
				);
			}
		);
		$('.vote').click(
			e=>{
				lib.server(
					'web/vote',
					{vote:$(e.target).data('vote'),book_id:$(e.target).closest('.book').data('id'),auth_token:sessionStorage.getItem('authToken')},
					()=>{lib.alert('voted');}
				);
			}
		);
		$('#to-list').click(showList);
		
		//init
		lib.ajaxForm('#search',initBooks);
	}
</script>
