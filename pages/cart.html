						<div id="books" class="container">
							<div id="headers" style="display:none;" class="row">
								<span class="col-2">Обложка</span>
								<span class="col-6">Название, авторы</span>
								<span class="col-1 text-right">Цена</span>
								<span class="col-1 text-right">Кол-во</span>
								<span class="col-2"></span>
							</div>
						</div>
						<div id="totals">
							Общая стоимость ₽<span class="cart-total"></span>
							<button id="buy" class="btn btn-primary hide">Купить</button>
						</div>
						<div><button id="to-shop" class="btn btn-primary">Вернуться в магазин</button></div>
<script>
	{
		let displayCartItem=r=>{
			let qty=
				$('<input/>',{class:'col-1 text-right qty',type:'number',min:'1'})
				.val(r.qty)
			;
			if(r.qty>r.onhand_qty){
				qty
				.addClass('bg-danger text-white')
				.prop('title','На складе '+r.onhand_qty+' книг')
				.attr('data-toggle','tooltip')
				.attr('data-placement','top')
			}
			$('<div/>',{class:'row'})
			.data(r)
			.append(
				$('<span/>',{class:'col-2'})
				.append(
					$('<a/>',{href:'#'}).append($('<img/>',{src:'img/book.png',class:'w-50'})) //'server.php?action=web/getImage&book_id='+r.book_id
				)
			)
			.append(
				$('<span/>',{class:'col-6'})
				.html(
					r.title+
					'. '+
					r.authors_list.map(
						author=>author.last_name+' '+author.first_name[0]+'.'+(author.last_name?' '+author.last_name[0]+'.':'')
					).join(', ')
				)
			)
			.append($('<span/>',{class:'col-1 text-right'}).html(r.price))
			.append(qty)
			.append(
				$('<span/>',{class:'col-2'})
				.append(
					$('<button/>',{type:'button',class:'btn btn-secondary btn-sm from-cart'}).html('Убрать')
				)
			)
			.appendTo($('#books'))
			;
		}
		//display books in cart
		let displayCart=data=>{
			$('#headers,#totals').toggle(data.rows.length>0);
			$('#books').children('div:not(:first-child)').remove();
			data.rows.forEach(displayCartItem);
			$('[data-toggle="tooltip"]').tooltip();
			displayCartInfo(data); //in header
			lib.alert(data.rows.length==0?'Корзина пуста':'В корзине книг: '+data.rows.length);
		}
		//refresh cart
		let refreshCart=()=>{
			lib.server('web/getCart',{auth_token:sessionStorage.getItem('authToken')},displayCart);
		}
		
		//event handlers
		$('#books').on(
			'show load ',
			'img',
			e=>{
				alert(e);
			}
		);
		$('#books').on(
			'click',
			'img',
			e=>{lib.displayPage('book');}
		);
		//change item quantity
		$('#books').on(
			'change',
			'input.qty',
			e=>{
				let row=$(e.currentTarget).closest('.row');
				let newValue=$(e.currentTarget).val();
				let diff=newValue-row.data().qty;
				row.data.qty=newValue;
				lib.server(
					'web/toCart',
					{auth_token:sessionStorage.getItem('authToken'),book_id:row.data().book_id,qty:diff},
					()=>{
						refreshCart();
						lib.alert('quantity changed');
					}
				);
			}
		);
		//remove item from cart
		$('#books').on(
			'click',
			'button.from-cart',
			e=>{
				lib.server(
					'web/fromCart',
					{auth_token:sessionStorage.getItem('authToken'),book_id:$(e.currentTarget).closest('.row').data().book_id},
					()=>{
						refreshCart();
						lib.alert('removed from cart');
					}
				);
			}
		);
		//buttons
		$('#buy').click(
			()=>{
				lib.server(
					'web/checkout',
					{auth_token:sessionStorage.getItem('authToken')},
					()=>{
						lib.displayPage('shop');
					}
				);
			}
		);
		$('#to-shop').click(()=>{lib.displayPage('shop')});
		
		//init
		refreshCart();
	}
</script>
