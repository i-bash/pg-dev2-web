<form id="run-task" class="form-inline panel" action="emp/runTask">
	<div class="form-group clearfix">
		<select id="programs" class="form-control" name="program_id"></select>
	</div>
	<div class="form-group clearfix">
		<textarea id="params" name="params">{}</textarea>
	</div>
	<div class="form-group clearfix">
		<input>
	</div>
	<button type="submit" class="btn btn-primary">Выполнить</button>
</form>
<div id="tasks" class="container">
	<div id="headers" style="display:none;" class="row">
		<span class="col-1 font-weight-bold">#</span>
		<span class="col-3 font-weight-bold">Название</span>
		<span class="col-2 font-weight-bold text-center">Запущено</span>
		<span class="col-2 font-weight-bold text-center">Завершено</span>
		<span class="col-2 font-weight-bold text-center">Статус</span>
		<span class="col-1 font-weight-bold text-center"></span>
	</div>
</div>
<script>
	{
		//populate tasks drop-down
		let populatePrograms=()=>
		lib.server(
			'emp/getPrograms',
			[],
			lib.populateSelect('#programs')
		);
		let populateTasks=()=>
		//display tasks
		lib.server(
			'emp/getTasks',
			[],
			data=>{
				lib.alert(data.rows.length==0?'Задания не найдены':'Найдено заданий: '+data.rows.length);
				$('#headers').toggle(data.rows.length>0);
				let list=$('#tasks');
				list.children('div:not(:first-child)').remove();
				data.rows.forEach(
					r=>{
						$('<div/>',{class:'row pt-1 pb-1'})
							.append($('<span/>',{class:'col-1 my-auto'}).html(r.task_id))
							.append($('<span/>',{class:'col-3 my-auto'}).html(r.name))
							.append($('<span/>',{class:'col-2 my-auto'}).html(r.started))
							.append($('<span/>',{class:'col-2 my-auto'}).html(r.finished))
							.append($('<span/>',{class:'col-2 my-auto'}).html(r.status))
							.append(
								$('<span/>',{class:'col-1 my-auto'}).html(
									$('<button/>',{class:'btn btn-secondary btn-sm show-results','data-id':r.task_id})
									.html('Результаты')
									.prop('disabled',!(['finished','error'].includes(r.status)))
								)
							)
							.appendTo(list)
						;
					}
				);
			}
		);
		lib.ajaxForm(
			'#run-task',
			data=>{
				populateTasks();
				alert('scheduled task #'+data.rows[0].run_program);
			},
			f=>{
				let json=$('#params').val();
				try{
					JSON.parse(json);
					return true;
				}
				catch(e){
					lib.alert('error parsing parameters:\n'+e.message);
					return false;
				}
			}
		);
		$('#tasks').on(
			'click',
			'.show-results',
			(e)=>{
				lib.server(
					'emp/taskResults',
					{task_id:$(e.currentTarget).data('id')},
					data=>{
						alert(data.rows[0].task_results);
					}
				);
			}
		);
		populatePrograms();
		populateTasks();
	}
</script>
