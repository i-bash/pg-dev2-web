<!DOCTYPE html>
<html>
	<head>
		<meta charset ="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="lib/bootstrap-4.4.1-dist/css/bootstrap.min.css"/>
		<link rel="stylesheet" href="main.css"/>
		<title>Учебное приложение DEV2</title>
	</head>
	<body>
		<!--div id="alert" class="modal"></div-->
		<div class="container">
			<div class="row">
				<div class="col-9 container-fluid">
					<h2>Учебное приложение DEV2</h2>
					<ul class="nav nav-tabs">
					  <li class="nav-item active">
						<a id="tab-shop" data-toggle="tab" class="nav-link" href="#shop">Книжный магазин</a>
					  </li>
					  <li class="nav-item">
						<a id="tab-admin" data-toggle="tab" class="nav-link" href="#admin">Админка</a>
					  </li>
					</ul>
						
					<div class="tab-content">
						<div id="shop" class="tab-pane fade in active">
							<div id="header1" class="container text-right clearfix pt-2 pb-2 border-bottom">
								<span id="logged-out">
									<button id="login" type="button" class="btn btn-info">Вход</button>
									<button id="register" type="button" class="btn btn-info">Регистрация</button>			
								</span>
								<span id="login-form">
									<form class="form-inline float-right" action="web/login">
										<input id="username" name="username" required placeholder="Имя пользователя">
										<button type="submit" class="btn btn-info ml-1">Войти</button>
										<button type="button" class="btn btn-info revert ml-1">&times;</button>
									</form>
								</span>
								<span id="register-form">
									<form class="form-inline float-right" action="web/register">
										<input id="reg-username" name="username" required placeholder="Имя пользователя">
										<input id="reg-email" type="email" name="email" required placeholder="Электронная почта" class="ml-1">
										<button type="submit" class="btn btn-info ml-1">Зарегистрироваться</button>
										<button type="button" class="btn btn-info revert ml-1">&times;</button>
									</form>
								</span>
								<span id="logged-in">
									<span id="session-info"></span>
									<button id="logout" class="btn btn-info">Выйти</button>
									<button id="cart" type="button" class="btn btn-info">Корзина ₽<span class="cart-total"></span></button>
								</span>
							</div>
						</div>
						<div id="admin" class="tab-pane fade">
							<ul class="nav nav-pills">
							  <li class="nav-item">
								<a data-toggle="pill" class="nav-link active" href="#" data-page="books">Книги</a>
							  </li>
							  <li class="nav-item">
								<a data-toggle="pill" class="nav-link" href="#" data-page="tasks">Фоновые задания</a>
							  </li>
							</ul>
						</div>
						<div id="page" class="mt-1"></div>
					</div>
				</div>

				<div id="techinfo" class="col-3 border pt-2 pb-2 container" style="display:flex;flex-flow:column nowrap;">
					<div class="row">
						<div class="col-7">
							<select id="server" class=""></select>
						</div>
						<div class="col-3 form-check" data-toggle="tooltip" data-placement="left" title="SET log_min_duration_statements = 0">
							<input type="checkbox" class="form-check-input" id="trace">
							<label class="form-check-label" for="trace">Trace</label>
						</div>
						<div class="col-2">
							<span id="loader" class="spinner-border spinner-border-sm invisible"></span>
						</div>
					</div>
					<div id="action" class="row mt-2 overflow-auto" style="flex-grow:10;"></div>
				</div>
			</div>
		</div>
		<script src="lib/jquery-3.4.1.min.js"></script>
		<script src="lib/popper.min.js"></script>
		<script src="lib/bootstrap-4.4.1-dist/js/bootstrap.min.js"></script>
		<script src="config.js"></script>
		<script src="main.js"></script>
		<script>
			//enable/disable elements
			let chkCmd=()=>{
				//get auth info from sessionStorage
				let authToken=sessionStorage.getItem('authToken');
				let userName=sessionStorage.getItem('userName');
				//auth header
				$('#session-info').html(userName+' ('+authToken+')');
				$('#logged-in').toggle(authToken!==null);
				$('#logged-out').toggle(authToken===null);
				$('#login-form').toggle(false);
				$('#register-form').toggle(false);
			};
			//display cart info (accepts data returned by getCart)
			let displayCartInfo=data=>{
				let cost=0;
				data.rows.forEach(
					r=>{
						cost+=r.qty*r.price;
					}
				);
				$('.cart-total').html(cost);
			};
			let refreshCartInfo=()=>{
				let authToken=sessionStorage.getItem('authToken');
				if(authToken==null){
					$('.cart-total').html(0);
				}
				else{
					lib.server(
						'web/getCart',
						{auth_token:authToken},
						displayCartInfo
					);
				};
			}

			//display page
			$('#admin a[data-page]').click(
				e=>{
					lib.displayPage($(e.target).data('page'));
				}
			);
			$('#login').click(
				e=>{
					$('#login-form').toggle(true);
					$('#register-form').toggle(false);
					$('#logged-out').toggle(false);
					$('#logged-in').toggle(false);
					$('#username').focus();
				}
			);
			$('#register').click(
				e=>{
					$('#login-form').toggle(false);
					$('#register-form').toggle(true);
					$('#logged-out').toggle(false);
					$('#logged-in').toggle(false);
					$('#reg-username').focus();
				}
			);
			$('button.revert').click(chkCmd);
			
			//tab
			$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
				switch(e.target.id){
				case 'tab-shop':
					lib.displayPage('shop');
				break;
				case 'tab-admin':
					lib.clearPage();
				break;
				}
			})

			//login
			lib.ajaxForm(
				'#login-form>form',
				data=>{
					sessionStorage.setItem('authToken',data.rows[0].login);
					sessionStorage.setItem('userName',$('#username').val());
					$('#username').val('');
					$('#shop').trigger('shop:login-logout');
					chkCmd();
				}
			);
			//logout
			$('#logout').click(
				e=>lib.server(
					'web/logout',
					{auth_token:sessionStorage.getItem('authToken')},
					()=>{
						sessionStorage.removeItem('authToken');
						sessionStorage.removeItem('userName');
						$('#shop').trigger('shop:login-logout');
						chkCmd();
					}
				)
			);
			//register
			lib.ajaxForm(
				'#register-form>form',
				data=>{
					alert('Пользователь '+$('#reg-username').val()+' зарегистрирован.');
					$('#reg-username').val('');
					$('#reg-email').val('');
					chkCmd();
				}
			);
			//cart
			$('#cart').click(e=>{lib.displayPage('cart');});

			////start
			lib.populateSelect(
				'#server',
				config.servers.map(
					s=>[
						Object.entries(s).map(entry=>entry[0]+'='+entry[1]).join(' '),
						s.host+':'+s.port,
						s
					]
				)
			);
			chkCmd();
		</script>
	</body>
</html>
