<!DOCTYPE html>
<html>
	<head>
		<meta charset ="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="lib/bootstrap-4.4.1-dist/css/bootstrap.min.css"/>
		<link rel="stylesheet" href="main.css"/>
		<title>Учебное приложение DEV2</title>
	</head>
	<body>
		<!--div id="alert" class="modal"></div-->
		<div class="container">
			<div class="row">
				<div class="col-9 container-fluid">
					<h2>Учебное приложение DEV2</h2>
					<!--div id="main" class="row"-->
					<ul class="nav nav-tabs">
					  <li class="nav-item active">
						<a id="tab-shop" data-toggle="tab" class="nav-link" href="#shop">Книжный магазин</a>
					  </li>
					  <li class="nav-item">
						<a id="tab-admin" data-toggle="tab" class="nav-link" href="#admin">Админка</a>
					  </li>
					</ul>
						
					<div class="tab-content">
						<div id="shop" class="tab-pane fade in active">
							<div id="header1" class="container text-right clearfix pt-2 pb-2 border-bottom">
								<span id="logged-out">
									<button id="login" type="button" class="btn btn-info">Вход</button>
									<button id="register" type="button" class="btn btn-info">Регистрация</button>			
								</span>
								<span id="login-form">
									<form class="form-inline float-right" action="web/login">
										<input id="username" name="username" required placeholder="Имя пользователя">
										<button type="submit" class="btn btn-info">Войти</button>
										<button type="button" class="btn btn-info revert"><img src="img/x.svg"></button>
									</form>
								</span>
								<span id="register-form">
									<form class="form-inline float-right" action="web/register">
										<input id="reg-username" name="username" required placeholder="Имя пользователя">
										<input id="reg-email" type="email" name="email" required placeholder="Электронная почта">
										<button type="submit" class="btn btn-info">Зарегистрироваться</button>
										<button type="button" class="btn btn-info revert"><img src="img/x.svg"></button>
									</form>
								</span>
								<span id="logged-in">
									<span id="session-info"></span>
									<button id="logout" class="btn btn-info">Выйти</button>
									<button id="cart" type="button" class="btn btn-info">Корзина</button>
								</span>
							</div>
						</div>
						<div id="admin" class="tab-pane fade">
							<ul class="nav nav-pills">
							  <li class="nav-item">
								<a data-toggle="pill" class="nav-link active" href="#" data-page="books">Книги</a>
							  </li>
							  <li class="nav-item">
								<a data-toggle="pill" class="nav-link" href="#" data-page="tasks">Фоновые задания</a>
							  </li>
							</ul>
						</div>
						<div id="page" class="mt-1"></div>
					</div>
				</div>

				<div id="techinfo" class="col-3 border pt-2 pb-2" style="display:flex;flex-flow:column nowrap;">
					<div style="flex-grow:0">
						<button id="btn-conninfo" class="col btn btn-link btn-sm" type="button" data-toggle="collapse" data-target="#conninfo-pane" aria-expanded="false" aria-controls="conninfo">
							conninfo
						</button>
						<span class="col form-check m-1" data-toggle="tooltip" data-placement="left" title="SET log_min_duration_statements = 0">
							<input type="checkbox" class="form-check-input" id="trace">
							<label class="form-check-label" for="trace">Trace</label>
						</span>
						<span id="loader" class="spinner-border spinner-border-sm invisible m-1"></span>
					</div>
					<div id="conninfo-pane" class="collapse" style="flex-grow:0">
						<div id="conninfo" class="col-12 border pl-2 pr-2"></div>
					</div>
					<div id="action" class="mt-2 overflow-auto" style="flex-grow:10;"></div>
				</div>
			</div>
		</div>
		<script src="lib/jquery-3.4.1.min.js"></script>
		<script src="lib/popper.min.js"></script>
		<script src="lib/bootstrap-4.4.1-dist/js/bootstrap.min.js"></script>
		<script src="main.js"></script>
		<script>
			$(
				()=>{
					//enable/disable elements
					let chkCmd=()=>{
						//get auth info from sessionStorage
						let authToken=sessionStorage.getItem('authToken');
						let userName=sessionStorage.getItem('userName');
						console.info(authToken);
						console.info(userName);
						//auth header
						$('#session-info').html(userName+' ('+authToken+')');
						$('#logged-in').toggle(authToken!==null);
						$('#logged-out').toggle(authToken===null);
						$('#login-form').toggle(false);
						$('#register-form').toggle(false);
					};
					
					//display page
					$('#admin a[data-page]').click(
						e=>{
							//$('#admin a[data-page]').not(e.target).removeClass('btn-primary').addClass('btn-info');
							//$(e.target).removeClass('btn-info').addClass('btn-primary');
							lib.displayPage($(e.target).data('page'));
						}
					);
					$('#login').click(
						e=>{
							$('#login-form').toggle(true);
							$('#register-form').toggle(false);
							$('#logged-out').toggle(false);
							$('#logged-in').toggle(false);
							$('#username').focus();
						}
					);
					$('#register').click(
						e=>{
							$('#login-form').toggle(false);
							$('#register-form').toggle(true);
							$('#logged-out').toggle(false);
							$('#logged-in').toggle(false);
							$('#reg-username').focus();
						}
					);
					$('button.revert').click(chkCmd);
					
					//tab
					$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
						switch(e.target.id){
						case 'tab-shop':
							lib.displayPage('shop');
						break;
						case 'tab-admin':
							lib.clearPage();
						break;
						}
					})

					//login
					lib.ajaxForm(
						'#login-form>form',
						data=>{
							sessionStorage.setItem('authToken',data.rows[0].login);
							sessionStorage.setItem('userName',$('#username').val());
							$('#username').val('');
							$('#shop').trigger('shop:login-logout');
							chkCmd();
						}
					);
					//logout
					$('#logout').click(
						e=>lib.server(
							'web/logout',
							{auth_token:sessionStorage.getItem('authToken')},
							()=>{
								sessionStorage.removeItem('authToken');
								sessionStorage.removeItem('userName');
								$('#shop').trigger('shop:login-logout');
								chkCmd();
							}
						)
					);
					//register
					lib.ajaxForm(
						'#register-form>form',
						data=>{
							alert('Пользователь '+$('#reg-username').val()+' зарегистрирован.');
							$('#reg-username').val('');
							$('#reg-email').val('');
							chkCmd();
						}
					);
					//cart
					$('#cart').click(e=>{lib.displayPage('cart');});

					////start
					chkCmd();
				}
			);
		</script>
	</body>
</html>
